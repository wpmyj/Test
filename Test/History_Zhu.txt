+===========================================================+
+--------------------UDS Scanner项目历史__Zhu---------------+         
+===========================================================+

date 17.02.06
------------------------------------------------------------
@author zhu
1、增加属性页--模板，置于首页，添加类CPage_Profile
2、类中增加LoadProfile函数，用于在listBox控件列出所有模板。

date 17.02.07
------------------------------------------------------------
@author zhu
1、安装IPP后学习其中提供的两个Demo：ippiDemo.exe以及ippsDemo.exe。开始不能打开，提示缺失dll，把上一级目录下bin中的dll全部拷贝进Demo所在路径，成功打开exe。
2、简要熟悉了ippiDemo.exe，其中主要的功能分三部分：ippIP（常规图像处理），iPPCC（颜色转换），ippCV（计算机视觉）。
3、继续驱动界面的修改：最终确定【模板】界面有六个功能按钮：新建、重命名、删除、重置、导入、导出按钮，在listbox中显示所有模板。
4、将属性页“扫描/保存”按钮响应从CPage_Base移到CPage_Profile类中，直接从【模板】界面实现扫描。
5、实现“新建”、“删除”功能，对应函数为NewTemplate（）与OnProfile_Btn_Delete（）。并增加SetDelete（）函数用来判定当模板为原始给定模板、默认模板时，不能使用删除按钮。
6、增加对话框类CDlg_Rename，用来重命名模板；并在CPage_Profile类中增加SetRename（）函数用来判定当模板为原始给定模板、默认模板以及上次使用模板时，不能使用重命名按钮。重命名功能还未实现。

date 17.02.08
------------------------------------------------------------
@author zhu
1、在MFC_UI类中增加bool RenameProfile(string strOldName, string strNewName)函数，利用rename()实现重命名功能。
2、增加重置按钮响应事件:OnProfile_Btn_Reset()；直接回到默认模板。
3、MFC_UI类增加string GetProfileNamePath()，返回模板存放路径，不包括模板文件名。
4、增加导入按钮的消息响应OnProfile_Btn_Import（）使用CFileDialog类实现打开对话框导入模板功能。
5、增加导出按钮的消息响应OnProfile_Btn_Export（），实现导出模板功能。
6、删除基本界面的模板模块。

date 17.02.09
------------------------------------------------------------
@author zhu
1、CPage_Profile 类增加两个父类指针，CPage_Custom* m_pBasePage;CPage_Custom* m_pAdPage;分别Sheet_Scanner类中初始化时赋值为基本与高级界面类的实例化对象。
2、修改Bug：CPage_Profile::LoadTemplate()中，加载模板的同时更新基本与高级界面UpdateControls（），但基本界面更新后直接退出；
解决：修改CPage_Base类的InitComboPixType（）与BaseStatus（）函数中，EnableWindow（）的使用由指针改为变量。
3、UpdateData（FALSE）是用来更新当前对话框界面的，在模板对话框更新基本对话框会弹出“不支持尝试执行的操作”的警告。
4、修改基本界面排版，调整控件类型并开始功能的实现。完成扫描模式的功能实现。

date 17.02.10
------------------------------------------------------------
@author zhu
1、修改基本界面排版，将多流输出由高级界面调整到基本界面，与单双面一起互斥为三个Radio。
2、解决单面、双面、多流状态未保存的Bug：原因是三者之间共用的int型value变量m_radiobtn_duplex的值互相影响了，并且在构造函数中，MFC会自动添加其值得初始化值，默认为-1，因此初始时总是未选中。
3、完成多流输出、单双面之间的参数联动，实现多流的功能。
4、将高级界面的纸张大小调到基本界面。完成相关功能实现。
5、完成基本界面修改。

date 17.02.13
------------------------------------------------------------
@author zhu
1、将基本界面“帮助”按钮调整到属性页上与“扫描”等按钮在一行；增加“帮助”按钮响应事件CSheet_Scanner::OnButtonCopy()执行ShellExecute（）。
2、同样增加“预览”按钮及其消息响应函数：OnButtonPreView（）。
3、增加CSheet_Scanner::SetPreViewStatus（）判断预览按钮是否可用
4、由于Sheet_Scanner类与MFC_UI类之间重复包含，在MFC_UI.h中没有包含#include "Sheet_Scanner.h"，所以在几个属性页中使用m_pUI->m_pSheet->SetPreViewStatus();时出现error:不允许指针指向不完整的类类型。为了不再各个属性页的cpp文件中都包含Sheet_Scanner.h，直接在MFC_UI类中增加PreViewStatus（）函数，利用MFC_UI的成员变量CSheet_Scanner* m_pSheet调用SetPreViewStatus（)。
5、为每个属性页都重载OnSetActive（）函数：该函数是CPropertyPage的成员函数，当选择某一页将其变为活动页时，框架会调用这个成员函数。这里重载此成员函数来执行m_pUI->PreViewStatus()；功能：只有在基本界面“预览”按钮才可用。
6、重载“关于”界面的构造函数为CPage_About(MFC_UI *pUI)，并增加成员变量MFC_UI  *m_pUI;

date 17.02.14
------------------------------------------------------------
@author zhu
1、查找IPP相关资料，主要熟悉文档第四章图像处理相关函数
2、将高级界面原纸张大小相关参数：宽，高，单位移到基本界面
3、调试表单sheet类预览按钮响应函数PreView():由于该函数是sheet类成员，但对应函数需要实现的功能却是与Base界面相关的，因此在Base类中添加同名成员函数，在sheet类中直接使用base类的实例化对象m_p_basepage调用同名成员函数。
   在base类的PreView()中借用CTWAINDS_UDS类的指针得到图像数据，但在显示到图片控件时遇到问题，没有bitmap数据头，需要自己写，代码编写中

date 17.02.15
------------------------------------------------------------
@author zhu
1、将黑白图相关参数：二值化与其Combobox移到基本界面，并且将之前的阈值滑动条关联两个Cap：阈值和去除斑点。
2、添加CPage_Base::SetBinarization（）函数设置参数联动：当多流黑白选中与单面或双面选中时，要设置二值化，当二值化为固定阈值时，对应ICAP_THRESHOLD；动态阈值时对应UDSCAP_SENSITIVETHRESHOLD_REMOVESPOTS（去除斑点）。
3、解决初始图像为彩色，阈值edit却可用的Bug：InitComboPixType（）由UpdateControl(）改到OnInitDialog（）中，因为后面SetBinarization（）时又设置回去了，因此放在OnInitDialog（）中，且在SetBinarization（）后。
4、在高级界面为图像拆分增加“自定义”选项，以及选中后下面的水平、垂直Radio以及edit（几等份）可用。但自定义等份功能未实现。
5、调整高级界面控件布局。

date 17.02.16
------------------------------------------------------------
@author zhu
1、增加【纸张】页面，将纸张大小、单位、宽高由基本界面移到纸张界面
2、在纸张界面增加X、Y偏移量以及边缘扩充：上下左右。采用滚动条控制edit显示的值。
3、增加int CPage_Paper::FindUnit(int index),返回单位的值
4、增加CPage_Paper::SetScroll，根据edit的值更新滚动条的值；以及设定滚动条的不同的范围和edit显示值得取值区间，当为英寸和厘米时，显示小数点后两位，其他比如像素、点等均直接显示整数。
5、解决Bug:重载滚动条响应OnVScroll（）时，改变其他滚动条都只控制一个edit的问题。
 方法：在OnVScroll（）的参数里有形参CScrollBar* pScrollBar，根据指针GetDlgCtrlID（），就能够判断是哪一个滚动条改变。
6、实现宽、高滚动条与edit的值同步。


date 17.02.17
------------------------------------------------------------
@author zhu
1、增加边缘扩充-上下左右的Cap：UDSCAP_EDGE_UP、UDSCAP_EDGE_DOWN、UDSCAP_EDGE_LEFT、UDSCAP_EDGE_RIGHT；并在CTWAINDS_UDS类中增加其初始化与值。
2、CPage_Paper类中根据容器值在edit中显示对应值，并且扫描时SetCapValue()时保存edit中的值
3、增加X、Y偏移量的Cap：UDSCAP_XPOS，UDSCAP_YPOS，及其相关功能。
4、重载OnPaint（）函数，在图片控件上侧与左侧手动绘制两个标尺，用来实时显示纸张大小的尺寸。

date 17.02.20
------------------------------------------------------------
@author zhu
1、在纸张界面增加【压缩】Combox选项以及对应JPEG压缩比：滑动条与edit。combox显示压缩类型，对应Cap为TWAIN自带Cap--ICAP_COMPRESSION，选项为自动、JPEG、G4;滑动条范围为0--100，对应Cap为自定义Cap：UDSCAP_COMPRESSVALUE；完成两者对应参数更新与保存的功能。
2、为基本界面多流的六个checkBox增加相应的按钮，使得点击按钮能够为每一张多流图像设置不同的参数。
3、实现在点击checkBox时，对应的按钮选中：在设置按钮高亮时，仅仅设置m_btn_backbw.SetFocus();m_btn_backbw.SetState()不够，还需要m_btn_backbw.SetButtonStyle(BS_DEFPUSHBUTTON)手动设置按钮的"Default"属性。
4、解决“多流”在不点击时，不输出多张图片的bug:在CPage_Base类的SetCapValue（）时，原来有根据int型变量m_radiobtn_duplex判断是否需要进行SetCapValueInt，实际上此处不需要再判断一次了，反而使得checkbox没有响应时，m_radiobtn_duplex变量不会重新赋值，不满足SetCapValueInt的条件。与control型radio变量不同，若是control型变量才需要判断GetCheck()。
5、解决选中双面，也出两张图，但是第二次打开界面是单面的Bug:SetFlat()中变量判断错误，又将m_radiobtn_duplex设为0了。

date 17.02.21
------------------------------------------------------------
@author zhu
1、完成新导入模板功能，界面更新以及参数生效（TW_LoadProfileFromFile）
2、解决模板问题：选中新建的模板时，修改其他参数，参数未生效问题。OnOK（）时只保存了上次使用模板，应该针对列表选中模板再次保存（注：必须是新建的模板才需再次保存）。问题解决。
3、多流Bug:上次多流正常扫描，再次打开驱动时直接退出
解决：初始化加载模板，m_pBasePage->UpdateControls()时，在SetMultistream中，使用了GetDlgItem(IDC_CHECK_FRONTGRAY)->EnableWindow(TRUE)的语句初始化界面。将初始化用到的所有使用GetDlgItem(ID)调用EnableWindow（）的地方全部改为成员变量调用。
4、解决多流相关Bug：首次扫描时，只有先点击了双面，再点击多流，多流才生效
方法：在Radio响应函数OnBase_RadioBtn_Duplex（）中，为scanside赋值要在scanside外，该变量与高级界面的SetCapValue()中的case UDSCAP_SPLITIMAGE（图像拆分）息息相关，当没有该变量赋值（默认为0）时，高级界面会把图像张数设为1。将scanside = m_radiobtn_duplex;放在UpdateControl();中，实时更新。
5、总结CScanner_OpenCV类中所用opencv相关函数以及所需图像数据的每一行的字节数、行数、列数、图像深度、通道数等。

date 17.02.22
------------------------------------------------------------
@author zhu
1、为模板导出功能由SHBrowseForFolder改为CFileDialog实现，导出的同时增加重命名的功能。

date 17.02.23
------------------------------------------------------------
@author zhu
1、删除之前增加的CTWAINDS_Base类的getUDSDIBImage（），重写CTWAIN_UI::PreView()函数，为图片数据手动增加文件头，信息头，调色板等，增加FillZero（）函数为数据补零，实现4字节对齐。
2、在CPage_Base::PreView()中通过m_pUI->PreView()得到数据，通过CFile类依次将文件头，信息头，调色板，以及图像数据，以此来测试数据是否正确。最终得到正确的图像数据。
3、利用CDC以及StretchDIBits（）在图片控件绘图，但保存的图片正确，图片控件却没有显示图片。改为CreateDIBitmap()与StretchBlt()实现图片显示，但是只能显示彩色图片，不能显示灰度图，黑白图的图像区域随机出现不同彩色，但是保存下来的图像正确。

date 17.02.24
------------------------------------------------------------
@author zhu
1、放弃直接绘图的方式，采用CFile读图的形式显示图片，仍然存在昨天的问题。最终采用opencv实现，仿照opencv的CvvImage类的DrawToHDC（），为CPage_Base类增加四个成员函数：NormalizeRect（）用来标准化处理rect区域，使其高度和宽度均为正值,当左侧坐标大于右侧坐标，上侧坐标大于下侧坐标时使用,互换；FillBitmapInfo用来写入信息头和调色板；RectToCvRect将坐标类型由Rect转为opencv能用的CvRect；Show（）使用DIB位图和颜色数据对dc上的指定矩形中的像素进行设置；最终使用DrawToHDC（）在指定dDCDst根据pDstRect绘图。完成黑白、灰度、彩色图片的预览功能。
2、解决“预览”后不能直接扫描，并且只能预览一次的Bug:在CTWAINDS_Base::DoXferReadyEvent()中，getImageInfo（）之前把m_CurrentState状态设为了dsState_XferReady了，所以当下次再次判断dsState_Enabled != m_CurrentState时，条件为真，使得DoXferReadyEvent（）返回false，没有后续的getImageInfo与_DSM_Entry（）。
解决方法：在CTWAIN_UI::PreView()函数的末尾将状态设回5：m_pDS->m_CurrentState = dsState_Enabled;但同时需要将CTWAINDS_Base类的成员m_CurrentState由protected改为public。问题解决。
3、防止图片显示在控件中失真，增加自适应图片控件的操作。
4、利用CRectTracker，响应OnLButtonDown实现在CPage_Paper的图片控件上画矩形。

date 17.02.27
------------------------------------------------------------
@author zhu
1、解决未扫描、直接从基本界面预览，图像下侧有部分数据丢失的Bug。在预览时，未响应CPage_Paper的SetCapValue，没有设置纸张大小。
2、完成OnPaint（）中，根据单位选值，分别画不同的标尺的功能。

date 17.02.28
------------------------------------------------------------
@author zhu
1、为CPage_Paper类增加两个成员m_standarindex，m_unitindex分别用来保存最开始纸张大小、单位选中项的索引值
2、在成员函数UpdatePicRectangle（int index, int unitindex）中，首先设置SetCapValueInt单位、纸张大小，再通过GetCurrentFrame得到当前纸张大小，并根据单位索引值对应的单位值计算该纸张大小值在图片控件下的大小。最后使用CDC->Rectangle与CPen绘红色矩形框.。
3、解决绘图时图像只绘制，不删除上次矩形图的Bug:在UpdatePicRectangle开始时InvalidateRect(NULL);再UpdateWindow();问题解决。
4、遗留一个问题：在界面初始打开时，响应UpdatePicRectangle（）函数，并不会画图，调试未找见问题。
5、调整CScanner_OpenCV类的图像锐化操作的代码：将Laplacian换为Sobel算子，但是不直接计算，而是分别计算x方向和y方向的导数，最后用两个方向的倒数去模拟梯度，最后将得到的grad与原图融合，得到的图像没有过去锐化，效果比直接使用Sobel算子要好。

date 17.03.1
------------------------------------------------------------
@author zhu
1、结合G系列驱动，删除纸张大小：A3、ISOB4、JISB4三个选项
2、调整单位选项为像素时，需要根据基本界面的分辨率调节对应的标尺，不同的分辨率，像素范围不同。
3、完善了纸张界面改变纸张大小，宽、高根据单位随之的变化以及图片控件上矩形框的变化。
4、暂时隐藏高级界面纸张自定义选项以及水平、垂直、输入edit
5、翻阅资料，使用PS常用的USM（unsharp mask）锐化方法对图像进行锐化，对比昨天的sobel算子锐化效果，该算法提取的边缘更准确，效果更好。
6、使用开运算操作（形态学算法：先腐蚀再膨胀）做去网纹的处理。结合OpenCV中的erode（腐蚀）、dilate（膨胀）函数，测试其去网纹的效果，但效果不好。接着直接采用GaussianBlur（）去网纹，效果相对于开运算有明显改善。

date 17.03.2
------------------------------------------------------------
@author zhu
1、为了实现去除背景功能，寻找更好的二值化算法，主要对比了OTSU与一维最大熵算法。在OpenCV类中增加int CScanner_OpenCV::otsu(Mat image) 算法以及Mat CScanner_OpenCV::MaxEntropy(Mat src, Mat &dst)最大熵算法，其中最大熵算法中求取了图像的直方图。在测试环境下，直接使用MaxEntropy得到的目标图像颜色有些失真，换为int CScanner_OpenCV::GetMaxEntropy(Mat src),得到一维熵最大时的阈值，将该阈值用于二值化；同样OTSU也得到类间方差最大时的阈值。对比两个阈值，认为还是OTSU算法得到的阈值更合适，采用OTSU算法。但直接二值化的图像为黑白图像，因此最后遍历整幅图像，将黑白图中为黑的像素点设置为原图中对应点的像素；其他为白的像素点则设置为白。但是还是因为阈值的问题，测试图片中有部分也被认为是背景去除了。完成去背景的操作。
2、为CPage_Paper类增加六个edit响应OnEnChangeBase_Edit_EdgeDown，响应在edit输入值时，同时改变滚动条以及m_papermap对应的值。
3、在CScanner_OpenCV类的preScanPrep() 中增加X、Y偏移量以及上下左右--边缘扩充的功能。利用opencv的copyMakeBorder函数实现边缘扩充的功能。

date 17.03.3

------------------------------------------------------------
@author zhu
//1、CPage_Paper::UpdateControls中，边缘扩充相关edit的值需要根据单位的选项进行修改，完成值之间的转换。未完成
1、界面增加色彩翻转功能，CScanner_OpenCV类实现该功能。
2、为G6x00系列驱动服务，界面增加缓存模式功能，选择项有自动、纸张数量、内存大小；并且增加滑动条设置对应的值，edit显示值。注意在edit输入时，需要使用SetSel设置光标位置一直在字符串后面。
3、重新调整自动裁切与校正、去穿孔所用图片，全部改为200dpi的图像；
解决cvGet2D崩溃的Bug；
同时调整算法中所需的阈值，完成自动裁切与校正以及去穿孔的算法优化。

date 17.03.6

------------------------------------------------------------
@author zhu
1、解决SmartScan软件使用DS驱动，模板未生效的Bug：在CTWAINDS_UDS::openDS中增加加载模板的操作，这样使App上设置的参数优先级更高，同时DS里其他参数也能生效；若在CTWAINDS_UDS::enableDS中加载模板，APP设置的参数将完全无效，扫描仪完全按照DS设置的参数扫描。
2、为各Page类的UpdateControls（）增加操作，每个参数更新时，都往Map中存入当前值，保证Map随容器一起更新